<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live G10 Currency Data – Spread & Change Highlighting</title>

  <!-- Include Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f2f2f2;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    #controls {
      text-align: center;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #007BFF;
      color: #fff;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #main-container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #007BFF;
      color: #fff;
    }
    tbody tr {
      cursor: pointer; /* Cursor indicates clickable rows */
    }
    #chart-title {
      text-align: center;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 18px;
      color: #333;
    }
    #chartContainer {
      flex: 1;
      height: 600px;
      width: 400px;
    }
  </style>
</head>
<body>
  <h1>Live G10 Currency Data</h1>
  <div id="controls">
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
  </div>

  <div id="main-container">
    <div id="table-container">
      <table id="currencyTable">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Bid</th>
            <th>Ask</th>
            <th>Spread (pips)</th>
            <th>Spread (%)</th>
            <th>spreadHigh</th>
            <th>spreadLow</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div id="chartContainer">
      <div id="chart-title">Spread Chart: EURUSD</div>
    </div>
  </div>

  <script>
    let socket = null;
    const previousValues = {};
    const spreadStats = {}
    let selectedSymbol = 'EURUSD';
    let chartData = [];
const MAX_TICKS = 300;

const chartElement = document.getElementById('chartContainer');
const chart = LightweightCharts.createChart(chartElement, {
  layout: { textColor: '#333', background: { type: 'solid', color: '#fff' } },
  width: chartElement.offsetWidth,
  height: 550,
  timeScale: {
    timeVisible: true,
    secondsVisible: true,
    borderColor: '#ccc'
  },
  rightPriceScale: { borderColor: '#ccc' },
});



const lineSeries = chart.addLineSeries({ color: '#2196F3', lineWidth: 2 });
    function formatTime(ts) {
  let timestamp = Number(ts);
  if (timestamp < 10000000000) {
    // It's in seconds, convert to ms
    timestamp *= 1000;
  }

  const date = new Date(timestamp);
  const timeStr = date.toLocaleTimeString('en-GB', {
    hour12: false,
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });

  const milliseconds = String(date.getMilliseconds()).padStart(3, '0');
  return `${timeStr}.${milliseconds}`;
}
chart.subscribeCrosshairMove(param => {
  if (param.time) {
    const msTime = param.time * 1000;
    const readable = new Date(msTime).toISOString();
    console.log("Hovered time:", readable);
  }
});

    function formatPrice(value) {
      const num = parseFloat(value);
      let fixed;
      if (num < 10) fixed = num.toFixed(5);
      else if (num < 100) fixed = num.toFixed(4);
      else fixed = num.toFixed(3);
      if (!fixed.includes('.')) fixed += '.00';
      const [intPart, decPart] = fixed.split('.');
      const paddedDec = decPart.padEnd(2, '0');
      const mainPart = paddedDec.slice(0, -2);
      const tail = paddedDec.slice(-2);
      return { mainPart: intPart + (mainPart ? '.' + mainPart : ''), tail };
    }

    function pipFactor(symbol) {
      return symbol.endsWith('JPY') ? 100 : 10000;
    }

    let lastChartTime = 0;

    function updateChart(data) {
  if (data.symbol !== selectedSymbol) return;

  const bid = parseFloat(data.bid);
  const ask = parseFloat(data.ask);
  const factor = pipFactor(data.symbol);
  const spreadPips = ((ask - bid) * factor).toFixed(2);  
  const ts = Number(data.ts);          // in ms
  const time = ts / 1000;              // convert ms → float seconds
      
  chartData.push({ time, value: parseFloat(spreadPips) });

  if (chartData.length > MAX_TICKS) chartData.shift();

  lineSeries.setData(chartData);
}
function updateTable(data) {
  const tbody = document.getElementById('tableBody');
  let row = document.getElementById('row-' + data.symbol);
  const isNew = !row;

  const bid = parseFloat(data.bid);
  const ask = parseFloat(data.ask);
  const factor = pipFactor(data.symbol);
  const spreadPips = parseFloat(((ask - bid) * factor).toFixed(2));
  const spreadPercent = ((ask - bid) / bid * 100).toFixed(4);

  // Track spread high/low per symbol
  if (!spreadStats[data.symbol]) {
    spreadStats[data.symbol] = { high: spreadPips, low: spreadPips };
  } else {
    spreadStats[data.symbol].high = Math.max(spreadStats[data.symbol].high, spreadPips);
    spreadStats[data.symbol].low = Math.min(spreadStats[data.symbol].low, spreadPips);
  }

  const bidFormatted = formatPrice(bid);
  const askFormatted = formatPrice(ask);

  const bidColor = previousValues[data.symbol]?.bid < bid ? 'green' :
                   previousValues[data.symbol]?.bid > bid ? 'red' : '';
  const askColor = previousValues[data.symbol]?.ask < ask ? 'green' :
                   previousValues[data.symbol]?.ask > ask ? 'red' : '';
  const bidBg = bidColor === 'green' ? '#d4edda' : bidColor === 'red' ? '#f8d7da' : '';
  const askBg = askColor === 'green' ? '#d4edda' : askColor === 'red' ? '#f8d7da' : '';

  previousValues[data.symbol] = { bid, ask };

  if (isNew) {
    row = document.createElement('tr');
    row.id = 'row-' + data.symbol;
    row.onclick = () => {
      selectedSymbol = data.symbol;
      chartData = [];
      lineSeries.setData([]);
      document.getElementById('chart-title').innerText = 'Spread Chart: ' + selectedSymbol;
    };
    tbody.appendChild(row);
  }

  row.innerHTML = `
    <td>${data.symbol}</td>
    <td style="background:${bidBg};">${bidFormatted.mainPart}<span style="color:${bidColor};">${bidFormatted.tail}</span></td>
    <td style="background:${askBg};">${askFormatted.mainPart}<span style="color:${askColor};">${askFormatted.tail}</span></td>
    <td>${spreadPips}</td>
    <td>${spreadPercent}%</td>
    <td>${spreadStats[data.symbol].high}</td>
    <td>${spreadStats[data.symbol].low}</td>
    <td>${formatTime(data.ts)}</td>
  `;
}

    function startConnection() {
      if (socket?.connected) return;
      socket = io();

      socket.on('connect', () => {
        document.getElementById('connectBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = false;
      });

      socket.on('disconnect', () => {
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
      });

      socket.on('market_update', (data) => {
        updateTable(data);
        updateChart(data);
      });

      socket.on('initial_data', (data) => {
        for (const symbol in data) updateTable(data[symbol]);
      });
    }

    function stopConnection() {
      socket?.disconnect();
      socket = null;
    }

    document.getElementById('connectBtn').onclick = startConnection;
    document.getElementById('disconnectBtn').onclick = stopConnection;
  </script>
</body>
</html>
